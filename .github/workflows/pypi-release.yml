# Publishes a single workspace package to PyPI when its GitHub release is created.
# The release tag must follow the convention: {package-name}-{version}
# e.g. serapeum-ollama-0.2.0, serapeum-core-0.1.0

name: pypi-release

permissions:
  contents: read

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Resolve package name from release tag
        run: |
          # Tag format: serapeum-ollama-0.2.0 â†’ package: serapeum-ollama
          TAG="${{ github.event.release.tag_name }}"
          PACKAGE=$(echo "$TAG" | sed 's/-[0-9].*//')
          echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
          echo "Publishing package: $PACKAGE  (tag: $TAG)"

      - name: Build and publish to PyPI
        uses: Serapieum-of-alex/github-actions/actions/release/pypi@main
        with:
          pypi-username: __token__
          pypi-password: ${{ secrets.PYPI_TEST_PUBLISH }}
          python-version: '3.12'
          package-manager: 'uv'
          install-groups: 'dev'
          verify-lock: 'true'
          pypi-repository-url: 'https://test.pypi.org/legacy/