name: Release Package

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to release'
        required: true
        type: choice
        options:
          - serapeum-ollama
          - serapeum-core
      increment:
        description: 'Version increment type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      prerelease-type:
        description: 'Prerelease type (none for a stable release)'
        required: false
        type: choice
        options:
          - none
          - alpha
          - beta
          - rc
        default: none
      draft:
        description: 'Create as draft release'
        type: boolean
        default: false
      release-branch:
        description: 'Branch to create the release from'
        required: false
        default: main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check actor is a repository admin
        run: |
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/${{ github.actor }}/permission --jq '.permission')
          echo "Permission level for ${{ github.actor }}: $PERMISSION"
          if [ "$PERMISSION" != "admin" ]; then
            echo "::error::${{ github.actor }} is not a repository admin. Only admins can trigger releases."
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve package path
        run: |
          case "${{ inputs.package }}" in
            serapeum-ollama) echo "PACKAGE_PATH=libs/providers/ollama" >> $GITHUB_ENV ;;
            serapeum-core)   echo "PACKAGE_PATH=libs/core"             >> $GITHUB_ENV ;;
          esac

      - name: Create GitHub Release
        uses: Serapieum-of-alex/github-actions/actions/release/github@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          release-branch: ${{ inputs.release-branch }}
          increment: ${{ inputs.increment }}
          prerelease-type: ${{ inputs.prerelease-type }}
          draft: ${{ inputs.draft }}
          package-manager: uv
          python-version: '3.12'
          install-groups: 'groups: docs dev'
          config-file: ${{ env.PACKAGE_PATH }}/pyproject.toml
