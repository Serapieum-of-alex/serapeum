# Publishes a single workspace package to PyPI.
#
# Triggers:
#   workflow_run:      Automatic when github-release.yml completes successfully.
#                      Resolves the package from the most recently pushed tag.
#   workflow_dispatch: Manual â€” choose the package and target registry.

name: pypi-release

permissions:
  contents: read

on:
  workflow_run:
    workflows: ['github-release']
    types: [completed]

  workflow_dispatch:
    inputs:
      package:
        description: 'Workspace package to publish'
        required: true
        type: choice
        options:
          - serapeum-ollama
          - serapeum-core

jobs:
  publish:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Resolve package name
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PACKAGE="${{ github.event.inputs.package }}"
          else
            PACKAGE=$(git tag --sort=-creatordate | grep -E '^serapeum-(ollama|core)-[0-9]+\.[0-9]+\.[0-9]+$' | head -1 | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+$//')
          fi
          echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
          echo "Publishing package: $PACKAGE"

      - name: Checkout latest release tag for package
        run: |
          git fetch --tags --force
          TAG=$(git tag --sort=-creatordate | grep -E "^${{ env.PACKAGE }}-[0-9]+\.[0-9]+\.[0-9]+$" | head -1)
          echo "Checking out tag: $TAG"
          git checkout "$TAG"

      - name: Build and publish to PyPI
        uses: Serapieum-of-alex/github-actions/actions/release/pypi@pypi-release/v1
        with:
          package: ${{ env.PACKAGE }}
          pypi-username: __token__
          pypi-password: ${{ secrets.PYPI_PUBLISH }}
          python-version: '3.12'
          package-manager: 'uv'
          install-groups: 'dev'
          verify-lock: 'false'
          # pypi-repository-url: 'https://test.pypi.org/legacy/'
