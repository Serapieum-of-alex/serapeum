# Publishes a single workspace package to PyPI.
#
# Triggers:
#   release:           Automatic on GitHub release creation.
#                      Tag must follow: {package-name}-{version}
#                      e.g. serapeum-ollama-0.2.0, serapeum-core-0.1.0
#   workflow_dispatch: Manual — choose the package and target registry.

name: pypi-release

permissions:
  contents: read

on:
  release:
    types: [created]

  workflow_dispatch:
    inputs:
      package:
        description: 'Workspace package to publish'
        required: true
        type: choice
        options:
          - serapeum-ollama
          - serapeum-core
      repository:
        description: 'Target PyPI registry'
        required: true
        type: choice
        default: testpypi
        options:
          - testpypi
          - pypi

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Resolve package name
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PACKAGE="${{ github.event.inputs.package }}"
          else
            # Tag format: serapeum-ollama-0.2.0 → serapeum-ollama
            TAG="${{ github.event.release.tag_name }}"
            PACKAGE=$(echo "$TAG" | sed 's/-[0-9].*//')
          fi
          echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
          echo "Publishing package: $PACKAGE"

      - name: Resolve PyPI repository URL
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPO="${{ github.event.inputs.repository }}"
          else
            REPO="pypi"
          fi

          if [ "$REPO" = "testpypi" ]; then
            echo "PYPI_REPO_URL=https://test.pypi.org/legacy/" >> $GITHUB_ENV
          else
            echo "PYPI_REPO_URL=" >> $GITHUB_ENV
          fi
          echo "Publishing to: ${REPO}"

      - name: Build and publish to PyPI
        uses: Serapieum-of-alex/github-actions/actions/release/pypi@main
        with:
          package: ${{ env.PACKAGE }}
          pypi-username: __token__
          pypi-password: ${{ secrets.PYPI_TEST_PUBLISH }}
          python-version: '3.12'
          package-manager: 'uv'
          install-groups: 'dev'
          verify-lock: 'true'
          pypi-repository-url: 'https://test.pypi.org/legacy/
