# Publishes a single workspace package to PyPI.
#
# Triggers:
#   workflow_run:      Automatic when github-release.yml completes successfully.
#                      Resolves the package from the most recently pushed tag.
#   workflow_dispatch: Manual — choose the package and target registry.

name: pypi-release

permissions:
  contents: read

on:
  workflow_run:
    workflows: ['github-release']
    types: [completed]

  workflow_dispatch:
    inputs:
      package:
        description: 'Workspace package to publish'
        required: true
        type: choice
        options:
          - serapeum-ollama
          - serapeum-core
      repository:
        description: 'Target PyPI registry'
        required: true
        type: choice
        default: testpypi
        options:
          - testpypi
          - pypi

jobs:
  publish:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Resolve package name
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PACKAGE="${{ github.event.inputs.package }}"
          else
            # Find the most recently created package-prefixed tag with semantic version
            git fetch --tags
            TAG=$(git tag --sort=-creatordate | grep -E '^serapeum-(ollama|core)-[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
            echo "Detected tag: $TAG"
            # Tag format: serapeum-ollama-0.2.0 → serapeum-ollama
            PACKAGE=$(echo "$TAG" | sed 's/-[0-9]\+\.[0-9]\+\.[0-9]\+$//')
          fi
          echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
          echo "Publishing package: $PACKAGE"

      - name: Resolve PyPI repository URL
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPO="${{ github.event.inputs.repository }}"
          else
            REPO="pypi"
          fi

          if [ "$REPO" = "testpypi" ]; then
            echo "PYPI_REPO_URL=https://test.pypi.org/legacy/" >> $GITHUB_ENV
          else
            echo "PYPI_REPO_URL=" >> $GITHUB_ENV
          fi
          echo "Publishing to: ${REPO}"

      - name: Build and publish to PyPI
        uses: Serapieum-of-alex/github-actions/actions/release/pypi@main
        with:
          package: ${{ env.PACKAGE }}
          pypi-username: __token__
          pypi-password: ${{ secrets.PYPI_TEST_PUBLISH }}
          python-version: '3.12'
          package-manager: 'uv'
          install-groups: 'dev'
          verify-lock: 'true'
          pypi-repository-url: 'https://test.pypi.org/legacy/
